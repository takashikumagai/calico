const e2k = {'accelerator': 'アクセル', 'accent': 'アクセント', 'access': 'アクセス', 'accessory': 'アクセサリー', 'activity': 'アクティビティ', 'adapter': 'アダプター', 'Africa': 'アフリカ', 'airmail': 'エアメール', 'album': 'アルバム', 'amateur': 'アマチュア', 'announcer': 'アナウンサー', 'antenna': 'アンテナ', 'apartment building': 'アパート', 'application': 'アプリケーション', 'approach': 'アプローチ', 'apron': 'エプロン', 'Arbeit': 'アルバイト', 'Asia': 'アジア', 'audio': 'オーディオ', 'assist': 'アシスト', 'badge': 'バッジ', 'balance': 'バランス', 'ball': 'ボール', 'ball pen': 'ボールペン', 'band': 'バンド', 'bar': 'バー', 'base': 'ベース', 'bat': 'バット', 'bath': 'バス', 'battery': 'バッテリー', 'bed': 'ベッド', 'bell': 'ベル', 'belt': 'ベルト', 'bench': 'ベンチ', 'best': 'ベスト', 'blouse': 'ブラウス', 'blue': 'ブルー', 'boat': 'ボート', 'bonus': 'ボーナス', 'boom': 'ブーム', 'boots': 'ブーツ', 'boy': 'ボーイ', 'boycott': 'ボイコット', 'brake': 'ブレーキ', 'broach': 'ブローチ', 'browser': 'ブラウザ', 'brush': 'ブラシ', 'bucket': 'バケツ', 'building': 'ビル', 'building': 'ビルディング', 'bus': 'バス', 'business': 'ビジネス', 'butter': 'バター', 'button': 'ボタン', 'buzzer': 'ブザー', 'bye-bye': 'バイバイ', 'cake': 'ケーキ', 'calendar': 'カレンダー', 'calorie': 'カロリー', 'camera': 'カメラ', 'cameraman': 'カメラマン', 'camp': 'キャンプ', 'campus': 'キャンパス', 'captain': 'キャプテン', 'card': 'カード', 'career': 'キャリア', 'carpet': 'カーペット', 'catch': 'キャッチ', 'cement': 'セメント', 'center': 'センター', 'ceremony': 'セレモニー', 'chalk': 'チョーク', 'chance': 'チャンス', 'change': 'チェンジ', 'channel': 'チャンネル', 'check': 'チェック', 'cheese': 'チーズ', 'chime': 'チャイム', 'chorus': 'コーラス', 'circle': 'サークル', 'class': 'クラス', 'classic': 'クラシック', 'clean': 'クリーン', 'cleaning': 'クリーニング', 'client': 'クライアント', 'coach': 'コーチ', 'collection': 'コレクション', 'color': 'カラー', 'come back': 'カムバック', 'comment': 'コメント', 'commercial': 'コマーシャル', 'communication': 'コミュニケーション', 'computer': 'コンピューター', 'concentric+plug': 'コンセント', 'concert': 'コンサート', 'concours': 'コンクール', 'concrete': 'コンクリート', 'contest': 'コンテスト', 'contrast': 'コントラスト', 'control': 'コントロール', 'cooler': 'クーラー', 'copy': 'コピー', 'corner': 'コーナー', 'cost': 'コスト', 'course': 'コース', 'cover': 'カバー', 'crane': 'クレーン', 'cream': 'クリーム', 'cunning': 'カンニング', 'cup': 'カップ', 'curry': 'カレー', 'curtain': 'カーテン', 'curve': 'カーブ', 'cut': 'カット', 'cycle': 'サイクル', 'dam': 'ダム', 'damage': 'ダメージ', 'dance': 'ダンス', 'data': 'データ', 'database': 'データベース', 'date': 'デート', 'decoration': 'デコレーション', 'demonstration': 'デモ', 'demonstration': 'デモンストレーション', 'department store': 'デパート', 'design': 'デザイン', 'desk': 'デスク', 'dessert': 'デザート', 'dessin': 'デッサン', 'device': 'デバイス', 'dial': 'ダイヤル', 'diamond': 'ダイヤモンド', 'director': 'ディレクター', 'directory': 'ディレクトリ', 'display': 'ディスプレイ', 'door': 'ドア', 'double': 'ダブル', 'down': 'ダウン', 'dozen': 'ダース', 'drama': 'ドラマ', 'dress': 'ドレス', 'drill': 'ドリル', 'drive': 'ドライブ', 'driver': 'ドライバー', 'dry': 'ドライ', 'dump': 'ダンプ', 'elegant': 'エレガント', 'elevator': 'エレベーター', 'encore': 'アンコール', 'Energie': 'エネルギー', 'engine': 'エンジン', 'engineer': 'エンジニア', 'enquête': 'アンケート', 'equal': 'イコール', 'escalator': 'エスカレーター', 'étiquette': 'エチケット', 'Europa': 'ヨーロッパ', 'fan': 'ファン', 'fastener': 'ファスナー', 'fight': 'ファイト', 'file': 'ファイル', 'film': 'フィルム', 'filter': 'フィルター', 'folder': 'フォルダー', 'fork': 'フォーク', 'form': 'フォーム', 'free': 'フリー', 'front': 'フロント', 'frypan': 'フライパン', 'game': 'ゲーム', 'gang': 'ギャング', 'garage': 'ガレージ', 'gas': 'ガス', 'gasoline': 'ガソリン', 'genre': 'ジャンル', 'glas': 'ガラス', 'glass': 'グラス', 'goal': 'ゴール', 'gramme': 'グラム', 'gray': 'グレー', 'group': 'グループ', 'guest': 'ゲスト', 'guide': 'ガイド', 'guidebook': 'ガイドブック', 'guitar': 'ギター', 'gum': 'ガム', 'Hamburg steak': 'ハンバーグ', 'handbag': 'ハンドバッグ', 'handkerchief': 'ハンカチ', 'handle': 'ハンドル', 'handsome': 'ハンサム', 'hanger': 'ハンガー', 'helicopter': 'ヘリコプター', 'hiking': 'ハイキング', 'hint': 'ヒント', 'hole': 'ホール', 'home': 'ホーム', 'hoos': 'ホース', 'hotel': 'ホテル', 'humor': 'ユーモア', 'ice cream': 'アイスクリーム', 'idea': 'アイデア', 'image': 'イメージ', 'impact': 'インパクト', 'inflation': 'インフレ', 'information': 'インフォメーション', 'input': 'インプット', 'intelligentsiya': 'インテリ', 'interchange': 'インターチェンジ', 'international': 'インターナショナル', 'interphone': 'インターフォン', 'interview': 'インタビュー', 'iron': 'アイロン', 'jam': 'ジャム', 'jazz': 'ジャズ', 'jeans': 'ジーンズ', 'jelly': 'ゼリー', 'journalist': 'ジャーナリスト', 'juice/deuce': 'ジュース', 'jumbo': 'ジャンボ', 'jump': 'ジャンプ', 'jumper': 'ジャンパー', 'junior': 'ジュニア', 'jupon': 'ズボン', 'Karte': 'カルテ', 'category': 'カテゴリー', 'keyboard': 'キーボード', 'kilo': 'キロ', 'knife': 'ナイフ', 'knock': 'ノック', 'koffie': 'コーヒー', 'kompas': 'コンパス', 'label': 'ラベル', 'lady': 'レディー', 'lamp': 'ランプ', 'lead': 'リード', 'leisure': 'レジャー', 'lens': 'レンズ', 'lesson': 'レッスン', 'level': 'レベル', 'lever': 'レバー', 'light': 'ライト', 'litre': 'リットル', 'load': 'ロード', 'lobby': 'ロビー', 'locker': 'ロッカー', 'login': 'ログイン', 'logout': 'ログアウト', 'loose': 'ルーズ', 'lunch': 'ランチ', 'macro': 'マクロ', 'mail': 'メール', 'maker': 'メーカー', 'mama': 'ママ', 'manager': 'マネージャー', 'mansion': 'マンション', 'marathon': 'マラソン', 'mark': 'マーク', 'market': 'マーケット', 'mask': 'マスク', 'mass communication': 'マスコミ', 'massage': 'マッサージ', 'master': 'マスター', 'match': 'マッチ', 'media': 'メディア', 'melody': 'メロディー', 'member': 'メンバー', 'memo': 'メモ', 'menu': 'メニュー', 'message': 'メッセージ', 'meter': 'メーター', 'milk': 'ミルク', 'minus': 'マイナス', 'misprint': 'ミスプリント', 'model': 'モデル', 'modern': 'モダン', 'monitor': 'モニター', 'monorail': 'モノレール', 'mood': 'ムード', 'motel': 'モーテル', 'motor': 'モーター', 'mouse': 'マウス', 'movie': 'ムービー', 'muffler': 'マフラー', 'music': 'ミュージック', 'napkin': 'ナプキン', 'necklace': 'ネックレス', 'necktie': 'ネクタイ', 'negative': 'ネガ', 'network': 'ネットワーク', 'Neurose': 'ノイローゼ', 'new': 'ニュー', 'news': 'ニュース', 'nonsense': 'ナンセンス', 'note': 'ノート', 'nuance': 'ニュアンス', 'number': 'ナンバー', 'nylon': 'ナイロン', 'office': 'オフィス', 'oil': 'オイル', 'Olympic': 'オリンピック', 'one-piece': 'ワンピース', 'online': 'オンライン', 'open': 'オープン', 'operation': 'オペレーション', 'option': 'オプション', 'orange': 'オレンジ', 'orchestra': 'オーケストラ', 'orgão': 'オルガン', 'orientation': 'オリエンテーション', 'out': 'アウト', 'output': 'アウトプット', 'pachinko': 'パチンコ', 'page': 'ページ', 'pair': 'ペア', 'pajamas': 'パジャマ', 'pants': 'パンツ', 'papa': 'パパ', 'party': 'パーティー', 'pass': 'パス', 'passport': 'パスポート', 'patrol car': 'パトカー', 'pattern': 'パターン', 'pek': 'ペンキ', 'pen': 'ペン', 'percent': 'パーセント', 'performance': 'パフォーマンス', 'personal computer': 'パソコン', 'pet': 'ペット', 'piano': 'ピアノ', 'picnic': 'ピクニック', 'pilot': 'パイロット', 'pin': 'ピン', 'pink': 'ピンク', 'pipe': 'パイプ', 'pistol': 'ピストル', 'plan': 'プラン', 'plastics': 'プラスチック', 'platform': 'プラットホーム', 'plus': 'プラス', 'pocket': 'ポケット', 'point': 'ポイント', 'pomp': 'ポンプ', 'pool': 'プール', 'position': 'ポジション', 'post': 'ポスト', 'poster': 'ポスター', 'pot': 'ポット', 'present': 'プレゼント', 'print': 'プリント', 'professional': 'プロ', 'program': 'プログラム', 'quiz': 'クイズ', 'race': 'レース', 'racket': 'ラケット', 'radio': 'ラジオ', 'rain coat': 'レインコート', 'range': 'レンジ', 'record': 'レコード', 'recreation': 'レクリエーション', 'recycle': 'リサイクル', 'register': 'レジ', 'regular': 'レギュラー', 'report': 'レポート', 'restaurant': 'レストラン', 'rhythm': 'リズム', 'ribbon': 'リボン', 'rice': 'ライス', 'rifle': 'ライフル', 'rival': 'ライバル', 'rocket': 'ロケット', 'romantic': 'ロマンチック', 'Röntgen': 'レントゲン', 'rope': 'ロープ', 'ropeway': 'ロープウエイ', 'rule': 'ルール', 'running': 'ランニング', 'rush hour': 'ラッシュアワー', 'salad': 'サラダ', 'salaried man': 'サラリーマン', 'sale': 'セール', 'sample': 'サンプル', 'sandal': 'サンダル', 'sandwich': 'サンドイッチ', 'save': 'セーブ', 'scan': 'スキャン', 'scarf': 'スカーフ', 'scenario': 'シナリオ', 'schedule': 'スケジュール', 'school': 'スクール', 'science': 'サイエンス', 'screen': 'スクリーン', 'script': 'スクリプト', 'season': 'シーズン', 'section': 'セクション', 'senior': 'シニア', 'sense': 'センス', 'series': 'シリーズ', 'service': 'サービス', 'set': 'セット', 'sewing machine': 'ミシン', 'shirt': 'シャツ', 'shock': 'ショック', 'shop': 'ショップ', 'show': 'ショー', 'shower': 'シャワー', 'shutter': 'シャッター', 'sign': 'サイン', 'siren': 'サイレン', 'size': 'サイズ', 'skate': 'スケート', 'ski': 'スキー', 'skirt': 'スカート', 'slacks': 'スラックス', 'slide': 'スライド', 'slipper': 'スリッパ', 'smart': 'スマート', 'smartphone': 'スマートフォン', 'socks': 'ソックス', 'sofa': 'ソファー', 'soft': 'ソフト', 'software': 'ソフトウェア', 'solo': 'ソロ', 'soup': 'スープ', 'space': 'スペース', 'speach': 'スピーチ', 'speaker': 'スピーカー', 'spoon': 'スプーン', 'sports': 'スポーツ', 'sports car': 'スポーツカー', 'spring': 'スプリング', 'stage': 'ステージ', 'stand': 'スタンド', 'star': 'スター', 'start': 'スタート', 'steak': 'ステーキ', 'steam': 'スチーム', 'stereo': 'ステレオ', 'stewardess': 'スチュワーデス', 'stocking': 'ストッキング', 'stop': 'ストップ', 'store': 'ストア', 'stove': 'ストーブ', 'straw': 'ストロー', 'stress': 'ストレス', 'strike': 'スト', 'strike': 'ストライキ', 'strobo': 'ストロボ', 'studio': 'スタジオ', 'style': 'スタイル', 'suit': 'スーツ', 'suitcase': 'スーツケース', 'sweater': 'セーター', 'switch': 'スイッチ', 'system': 'システム', 'table': 'テーブル', 'talent': 'タレント', 'tape': 'テープ', 'tape recorder': 'テープレコーダー', 'taxi': 'タクシー', 'team': 'チーム', 'teamwork': 'チームワーク', 'technique': 'テクニック', 'television': 'テレビ', 'telex': 'テレックス', 'tempo': 'テンポ', 'tennis': 'テニス', 'tennis court': 'テニスコート', 'tent': 'テント', 'test': 'テスト', 'text': 'テキスト', 'thank you': 'サンキュー', 'theme': 'テーマ', 'tile': 'タイル', 'time': 'タイム', 'timely': 'タイムリー', 'timer': 'タイマー', 'timing': 'タイミング', 'tire': 'タイヤ', 'title': 'タイトル', 'toilet': 'トイレ', 'tone': 'トーン', 'top': 'トップ', 'towel': 'タオル', 'tower': 'タワー', 'track': 'トラック', 'training': 'トレーニング', 'transistor': 'トランジスター', 'trouble': 'トラブル', 'trump': 'トランプ', 'tunnel': 'トンネル', 'type': 'タイプ', 'typewriter': 'タイプライター', 'typist': 'タイピスト', 'uniform': 'ユニフォーム', 'unique': 'ユニーク', 'up': 'アップ', 'update': 'アップデート', 'upgrade': 'アップグレード', 'veteran': 'ベテラン', 'video': 'ビデオ', 'vinyl': 'ビニール', 'violin': 'バイオリン', 'virus': 'ウイルス', 'Vitamin': 'ビタミン', 'waitress': 'ウエイトレス', 'watt': 'ワット', 'web': 'ウェブ', 'wine': 'ワイン', 'woman': 'ウーマン', 'wool': 'ウール', 'yacht': 'ヨット', 'young': 'ヤング', 'zero': 'ゼロ' };

// let debug
// if (process.env.NODE_ENV !== 'production') {
//   debug = require('debug')('transover')
// } else {
//   debug = () => {}
// }
function debug(message) {
  console.log(message);
}

let options
let disable_on_this_page

function ignoreThisPage(options) {
  const isBlacklisted = $.grep(options.except_urls, function(url) { return RegExp(url).test(window.location.href) }).length > 0
  const isWhitelisted = $.grep(options.only_urls, function(url) { return RegExp(url).test(window.location.href) }).length > 0 ||
    options.only_urls.length === 0

  return isBlacklisted || !isWhitelisted
}

// Append the template DOM to the root element of document
function createPopup(nodeType) {
  document.documentElement.appendChild(templates[templateIds[nodeType]])
  return $('<'+nodeType+'>')
}

function removePopup(nodeType) {
  $(nodeType).each(function() {
    const self = this
    $(this.shadowRoot.querySelector('main')).fadeOut('fast', function() { self.remove() })
  })

  // Remove the template element from the DOM
  $('#'+templateIds[nodeType]).remove()
}

const templates = {}
const templateIds = {
  'transover-popup': 'transover-popup-template',
  'transover-type-and-translate-popup': 'transover-tat-popup-template'
}

/**
 * - Loads a DOM that represents the text box for displaying candidates
 *   and stores it in a variable.
 * - Does not attach the loaded DOM to the document
 * - Attaches the JavaScript for the loaded DOM to the head of the DOM
 *   of the original page (not the loaded one)
 * 
 * @param {*} component 
 */
function registerTransoverComponent(component) {
  const html = component + '.html'
  const script = component + '.js'

  const xhr = new XMLHttpRequest()
  xhr.open('GET', chrome.extension.getURL(html), true)
  xhr.responseType = 'document'
  xhr.onload = function(e) {
    const doc = e.target.response
    const template = doc.querySelector('template') // template is the root element of the html we load and use
    templates[template.id] = template
  }
  xhr.send()

  const s = document.createElement('script')
  s.type = 'text/javascript'
  s.src = chrome.extension.getURL(script)
  s.async = true
  document.head.appendChild(s)
}

let last_translation

function showPopup(e, content) {
  removePopup('transover-type-and-translate-popup')

  // Append the text box DOM to the root of the page DOM
  const $popup = createPopup('transover-popup')

  // Also append text box DOM to the body element
  $('body').append($popup)

  $popup.on('transover-popup_content_updated', function() {
    const pos = calculatePosition(e.clientX, e.clientY, $popup)
    $popup
      .each(function() {
        $(this.shadowRoot.querySelector('main')).hide()
      })
      .attr({ top: pos.y, left: pos.x })
      .each(function() {
        $(this.shadowRoot.querySelector('main')).fadeIn('fast')
      })
  })
  $popup.attr({content, options: JSON.stringify(options)})
}

function calculatePosition(x, y, $popup) {
  const pos = {}

  pos.x = x;
  pos.y = y;

  return pos
}

function loadOptions() {
  // chrome.extension.sendRequest({handler: 'get_options'}, function(response) {
  //   options = JSON.parse( response.options )
  //   disable_on_this_page = ignoreThisPage(options)
  //   chrome.extension.sendRequest({handler: 'setIcon', disabled: disable_on_this_page})
  // })
}
loadOptions()

document.addEventListener('visibilitychange', function () {
  if (!document.hidden) {
    loadOptions()
  }
}, false)

let show_popup_key_pressed = false
$(document).keydown(function(e) {
  // Hide tat popup on escape
  if (e.keyCode == 27) {
    removePopup('transover-type-and-translate-popup')
  }
}).keyup(function(e) {
  console.log('keyup')
  // if (TransOver.modifierKeys[e.keyCode] == options.popup_show_trigger) {
  //   show_popup_key_pressed = false
  // }
})

let timer25
const last_mouse_stop = {x: 0, y: 0}

$(document).scroll(function() {
  removePopup('transover-popup')
})

// setup mousestop event
$(document).on('mousemove_without_noise', function(e){
  removePopup('transover-popup')

  clearTimeout(timer25)

  if (options) {
    let delay = options.delay

    if (window.getSelection().toString()) {
      if (options.selection_key_only) {
        delay = 200
      }
    } else {
      if (options.word_key_only) {
        delay = 200
      }
    }

    timer25 = setTimeout(function() {
      const mousestop = new $.Event('mousestop')
      last_mouse_stop.x = mousestop.clientX = e.clientX
      last_mouse_stop.y = mousestop.clientY = e.clientY

      $(document).trigger(mousestop)
    }, delay)
  }
})

document.addEventListener('input', e => {
  console.log(`Input event: ${e.target.value}`);
  let text = e.target.value;
  if(text === '') {
    removePopup('transover-popup');
  } else {
    let wordInKatakana = e2k[text];
    if(wordInKatakana != undefined) {
      console.log(`${text} -> ${wordInKatakana}`);

      //console.log(`client(X,Y): ${e.clientX}, ${e.clientY}`); -> undefined
      //console.log(`target.style(left,top): ${e.target.style.left}, ${e.target.style.top}`); -> empty
      //console.log(`e.target(left,top): ${e.target.left}, ${e.target.top}`); -> undefined
      console.log(`target.offset(left,top): ${e.target.offsetLeft}, ${e.target.offsetTop}`);
      //console.log(`currentTarget.offset(left,top): ${e.currentTarget.offsetLeft}, ${e.currentTarget.offsetTop}`); -> undefined
      console.log(`parentNode.offset(left,top): ${e.target.parentNode.offsetLeft}, ${e.target.parentNode.offsetTop}`);
      console.log(`parentNode.parentNode.offset(left,top): ${e.target.parentNode.parentNode.offsetLeft}, ${e.target.parentNode.parentNode.offsetTop}`);

      // Event.target is not guaranteed to be an HTML element but this seems to work
      const rect = e.target.getBoundingClientRect();
      console.log(`client rect xywh: ${rect.x}, ${rect.y}, ${rect.width}, ${rect.height}`);
  
      const t = e.target;
      // const x = t.offsetLeft + t.parentNode.offsetLeft + t.parentNode.parentNode.left;
      // const y = t.offsetTop + t.parentNode.offsetTop + t.parentNode.parentNode.offsetTop;
      const expected_input_field_height = 36;
      const x = rect.x;
      const y = rect.y + expected_input_field_height;
      const xy = { clientX: x, clientY: y };
      showPopup(xy, wordInKatakana);
    }
  }
});

chrome.runtime.onMessage.addListener(
  function(request) {
    if (window != window.top) return

    if (request == 'open_type_and_translate') {
      // if ($('transover-type-and-translate-popup').length == 0) {
      //   chrome.extension.sendRequest({handler: 'get_last_tat_sl_tl'}, function(response) {
      //     const $popup = createPopup('transover-type-and-translate-popup')
      //     const languages = $.extend({}, TransOverLanguages)

      //     if (response.sl) {
      //       languages[response.sl].selected_sl = true
      //     }
      //     languages[response.tast_tl || options.target_lang].selected_tl = true

      //     $popup.attr('data-languages', JSON.stringify(languages))
      //     $popup.attr('data-disable_on_this_page', disable_on_this_page)
      //     $('body').append($popup)
      //     $popup.each(function() {
      //       $(this.shadowRoot.querySelector('main')).hide().fadeIn('fast')
      //     })
      //   })
      // }
      // else {
      //   removePopup('transover-type-and-translate-popup')
      // }
    } else if (request == 'select-candidate-in-active-tab') {
      console.log('received select-candidate-in-active-tab');
    }
  }
)

$(function() {
  registerTransoverComponent('popup')
  //registerTransoverComponent('tat_popup')
})

window.addEventListener('message', function(e) {
  // We only accept messages from ourselves
  if (e.source != window)
    return

  // if (e.data.type == 'transoverTranslate') {

  // } else if (e.data.type === 'toggle_disable_on_this_page') {

  // } else if (e.data.type === 'tat_close') {

  // }
})
